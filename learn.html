<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mindset - Learn</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* Harmonious Color Palette */
            --primary-color: #4A6CF7;
            --secondary-color: #7C3AED;
            --accent-color: #EC4899;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --error-color: #EF4444;
            --info-color: #3B82F6;

            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #4A6CF7 0%, #7C3AED 100%);
            --gradient-secondary: linear-gradient(135deg, #7C3AED 0%, #EC4899 100%);
            --gradient-accent: linear-gradient(135deg, #EC4899 0%, #F59E0B 100%);
            --gradient-success: linear-gradient(135deg, #10B981 0%, #3B82F6 100%);
            --gradient-info: linear-gradient(135deg, #3B82F6 0%, #4A6CF7 100%);
            --gradient-warning: linear-gradient(135deg, #F59E0B 0%, #EF4444 100%);
            --gradient-danger: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);

            /* Text Colors */
            --text-dark: #1F2937;
            --text-light: #6B7280;
            --text-white: #FFFFFF;

            /* Background Colors */
            --bg-white: #FFFFFF;
            --bg-light: #F9FAFB;
            --bg-gray: #F3F4F6;

            /* Sidebar Colors */
            --sidebar-bg: #1F2937;
            --sidebar-text: #9CA3AF;
            --sidebar-active: #4A6CF7;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #F9FAFB;
            color: var(--text-dark);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: grid;
            grid-template-columns: 70px 1fr;
            height: 100vh;
            overflow: hidden;
        }

        /* Left Sidebar - Icons Only */
        .sidebar {
            background: var(--sidebar-bg);
            padding: 20px 0;
            color: var(--sidebar-text);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }

        .sidebar .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--bg-white);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: var(--radius-lg);
            background: var(--gradient-primary);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .sidebar .logo:hover {
            transform: scale(1.05);
        }

        .sidebar nav ul {
            list-style: none;
            flex-grow: 1;
            width: 100%;
        }

        .sidebar nav li {
            margin-bottom: 8px;
            display: flex;
            justify-content: center;
        }

        .sidebar nav a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            color: var(--sidebar-text);
            text-decoration: none;
            border-radius: var(--radius-lg);
            transition: all 0.3s ease;
            position: relative;
        }

        .sidebar nav a:hover,
        .sidebar nav a.active {
            background-color: rgba(74, 108, 247, 0.1);
            color: var(--sidebar-active);
            transform: translateX(5px);
        }

        .sidebar nav a i {
            font-size: 1.4rem;
        }

        .sidebar nav a .tooltip {
            position: absolute;
            left: 70px;
            background: var(--sidebar-bg);
            color: var(--bg-white);
            padding: 8px 12px;
            border-radius: var(--radius-md);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .sidebar nav a:hover .tooltip {
            opacity: 1;
        }

        /* Main Content Area */
        .main-content {
            padding: 25px 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100vh;
            background: var(--bg-white);
        }

        /* Learning View Container */
        .learning-view-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex-grow: 1;
            min-height: 0;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background: var(--gradient-primary);
            border-radius: var(--radius-xl);
            padding: 6px;
            box-shadow: var(--shadow-md);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-white);
            box-shadow: var(--shadow-sm);
        }

        .tab-btn i {
            font-size: 1.2rem;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            flex-direction: column;
            gap: 20px;
            flex-grow: 1;
            min-height: 0;
        }

        .tab-content.active {
            display: flex;
        }

        /* Learning List View */
        .learning-list-view {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex-grow: 1;
        }

        .learning-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .action-btn {
            background: var(--gradient-primary);
            color: var(--text-white);
            border: none;
            padding: 12px 20px;
            border-radius: var(--radius-full);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-md);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .lessons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            flex-grow: 1;
            overflow-y: auto;
            padding: 5px;
        }

        .lesson-card {
            border-radius: var(--radius-xl);
            padding: 25px;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            height: 200px;
            display: flex;
            flex-direction: column;
            background: var(--gradient-primary);
            /* Ensure gradient is visible */
        }

        .lesson-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .lesson-card h3 {
            font-size: 1.4rem;
            margin-bottom: 12px;
            color: var(#EF4444);
            font-weight: 600;
        }

        .lesson-card p {
            color: rgba(0, 0, 0, 0.9);
            margin-bottom: 15px;
            flex-grow: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .lesson-card .lesson-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lesson-card .topic-count {
            display: flex;
            align-items: center;
            gap: 5px;
            color: rgba(11, 79, 63, 0.9);
            font-size: 0.9rem;
        }

        .lesson-card .shared-by {
            display: flex;
            align-items: center;
            gap: 5px;
            color: rgba(87, 9, 104, 0.9);
            font-size: 0.9rem;
        }

        /* Lesson Detail View */
        .lesson-detail-view {
            display: none;
            flex-direction: column;
            gap: 15px;
            flex-grow: 1;
            min-height: 0;
        }

        /* Lesson Header */
        .lesson-header {
            background: var(--gradient-secondary);
            border-radius: var(--radius-xl);
            padding: 15px 20px;
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lesson-header h2 {
            font-size: 1.5rem;
            color: var(--text-white);
        }

        .lesson-header .lesson-actions {
            display: flex;
            gap: 10px;
        }

        .lesson-header .action-btn-small {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-white);
            border: none;
            padding: 8px 12px;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .lesson-header .action-btn-small:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .lesson-header .close-btn {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-white);
            border: none;
            padding: 8px 12px;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .lesson-header .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Breadcrumb Navigation */
        .breadcrumb-nav {
            background: var(--gradient-info);
            border-radius: var(--radius-xl);
            padding: 12px 20px;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 10px;
            overflow-x: auto;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .breadcrumb-item.active {
            color: var(--text-white);
            font-weight: 500;
        }

        .breadcrumb-item i {
            font-size: 0.8rem;
        }

        .breadcrumb-separator {
            color: rgba(255, 255, 255, 0.6);
        }

        .lesson-content {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 20px;
            flex-grow: 1;
            min-height: 0;
        }

        /* Navigation Panel - Branch System */
        .navigation-panel {
            background: var(--gradient-success);
            border-radius: var(--radius-xl);
            padding: 20px;
            box-shadow: var(--shadow-md);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }

        .nav-tree {
            list-style: none;
            flex-grow: 1;
            position: relative;
        }

        .nav-tree li {
            margin-bottom: 15px;
            position: relative;
        }

        .nav-tree .nav-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all 0.3s ease;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-white);
            position: relative;
            z-index: 2;
        }

        .nav-tree .nav-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .nav-tree .nav-item.active {
            background: rgba(255, 255, 255, 0.3);
            color: var(--text-white);
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        .nav-tree .nav-item i {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        .nav-tree .nav-item span {
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nav-tree .nav-children {
            margin-left: 30px;
            margin-top: 15px;
            position: relative;
        }

        /* Branch Connection Lines */
        .nav-tree .nav-children::before {
            content: '';
            position: absolute;
            left: -15px;
            top: -15px;
            bottom: 15px;
            width: 2px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 1;
        }

        .nav-tree .nav-children li::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 20px;
            width: 15px;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 1;
        }

        .nav-tree .nav-children li:last-child::after {
            content: '';
            position: absolute;
            left: -15px;
            top: 20px;
            bottom: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 1;
        }

        /* Node Indicators */
        .nav-tree .nav-item::before {
            content: '';
            position: absolute;
            left: -5px;
            width: 10px;
            height: 10px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.5);
            z-index: 3;
        }

        .nav-tree .nav-item.active::before {
            background: var(--text-white);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .add-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-full);
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.3s ease;
            gap: 8px;
        }

        .add-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Content Area */
        .content-area {
            background: var(--bg-white);
            border-radius: var(--radius-xl);
            padding: 25px;
            box-shadow: var(--shadow-md);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex-grow: 1;
            border: 1px solid var(--bg-gray);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--bg-gray);
        }

        .content-header h3 {
            font-size: 1.5rem;
            color: var(--text-dark);
        }

        .content-actions {
            display: flex;
            gap: 10px;
        }

        .content-action-btn {
            background: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--bg-gray);
            padding: 8px 12px;
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .content-action-btn:hover {
            background: var(--gradient-primary);
            color: var(--text-white);
            border-color: transparent;
        }

        .content-action-btn.delete-btn {
            background: var(--bg-light);
            color: var(--error-color);
            border: 1px solid var(--bg-gray);
        }

        .content-action-btn.delete-btn:hover {
            background: var(--gradient-danger);
            color: var(--text-white);
            border-color: transparent;
        }

        .content-body {
            flex-grow: 1;
            overflow-y: auto;
            background: var(--bg-light);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        /* Document Editor */
        .document-editor {
            width: 100%;
            min-height: 500px;
            border: 1px solid var(--bg-gray);
            border-radius: var(--radius-lg);
            padding: 20px;
            background: var(--bg-white);
            position: relative;
        }

        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--bg-gray);
        }

        .editor-btn {
            background: var(--bg-white);
            border: 1px solid var(--bg-gray);
            border-radius: var(--radius-md);
            padding: 8px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .editor-btn:hover {
            background: var(--bg-light);
            border-color: var(--primary-color);
        }

        .editor-btn.active {
            background: var(--gradient-primary);
            color: var(--text-white);
            border-color: transparent;
        }

        .editor-content {
            min-height: 400px;
            padding: 15px;
            background: var(--bg-white);
            border-radius: var(--radius-md);
            outline: none;
            font-size: 1rem;
            line-height: 1.6;
        }

        .editor-content:focus {
            border: 1px solid var(--primary-color);
        }

        /* Table Styles */
        .table-container {
            margin: 15px 0;
            overflow-x: auto;
        }

        .custom-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .custom-table th,
        .custom-table td {
            border: 1px solid var(--bg-gray);
            padding: 8px 12px;
            text-align: left;
        }

        .custom-table th {
            background-color: var(--bg-light);
            font-weight: 600;
        }

        .custom-table tr:nth-child(even) {
            background-color: var(--bg-light);
        }

        /* Checkbox Styles */
        .checkbox-container {
            margin: 10px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            border-radius: var(--radius-sm);
        }

        .checkbox-item label {
            cursor: pointer;
            user-select: none;
        }

        /* Chart/Graph Styles */
        .chart-container {
            margin: 15px 0;
            padding: 15px;
            background: var(--bg-white);
            border: 1px solid var(--bg-gray);
            border-radius: var(--radius-lg);
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-placeholder {
            text-align: center;
            color: var(--text-light);
        }

        /* Loading Animation */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(74, 108, 247, 0.2);
            border-top: 4px solid var(--primary-color);
            border-radius: var(--radius-full);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            margin-top: 15px;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-white);
            border-radius: var(--radius-xl);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-xl);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            color: var(--text-dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: var(--radius-full);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--text-dark);
            background: var(--bg-light);
            transform: rotate(90deg);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--bg-gray);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--text-white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--bg-gray);
        }

        .btn-secondary:hover {
            background: var(--bg-gray);
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: var(--text-white);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Share Modal Styles */
        .share-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .share-option {
            padding: 15px;
            border: 1px solid var(--bg-gray);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-option:hover {
            background: var(--bg-light);
            border-color: var(--primary-color);
        }

        .share-option.active {
            background: rgba(74, 108, 247, 0.05);
            border-color: var(--primary-color);
        }

        .share-option-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .share-option-title {
            font-weight: 600;
            color: var(--text-dark);
        }

        .share-option-description {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .share-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--bg-gray);
        }

        .access-level {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .access-option {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--bg-gray);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .access-option:hover {
            background: var(--bg-light);
        }

        .access-option.active {
            background: var(--gradient-primary);
            color: var(--text-white);
            border-color: transparent;
        }

        /* Notification Styles */
        .notification-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1001;
        }

        .notification {
            padding: 15px 20px;
            background: var(--gradient-success);
            color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease-out;
            max-width: 300px;
        }

        .notification.error {
            background: var(--gradient-danger);
        }

        .notification.info {
            background: var(--gradient-info);
        }

        .notification.warning {
            background: var(--gradient-warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: var(--sidebar-bg);
            color: var(--bg-white);
            border: none;
            padding: 10px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .mobile-menu-toggle:hover {
            background: var(--gradient-primary);
            transform: scale(1.05);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: fixed;
                top: 0;
                height: 100vh;
                z-index: 999;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin: 0;
            }

            .mobile-menu-toggle {
                display: block;
            }

            .lesson-content {
                grid-template-columns: 1fr;
            }

            .navigation-panel {
                display: none;
            }
        }

        /* Update Indicator */
        .update-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            background: var(--accent-color);
            border-radius: var(--radius-full);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(236, 72, 153, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(236, 72, 153, 0);
            }
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            background: var(--gradient-primary);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-xl);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--text-light);
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--text-dark);
        }

        .empty-state p {
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .empty-state .action-btn {
            margin-top: 10px;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            padding: 8px 0;
            z-index: 1000;
            display: none;
            min-width: 180px;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-dark);
        }

        .context-menu-item:hover {
            background: var(--bg-light);
        }

        .context-menu-item.delete {
            color: var(--error-color);
        }

        .context-menu-item i {
            width: 16px;
        }

        /* Edit Modal */
        .edit-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Delete Confirmation */
        .delete-confirmation {
            text-align: center;
            padding: 20px 0;
        }

        .delete-confirmation i {
            font-size: 3rem;
            color: var(--error-color);
            margin-bottom: 15px;
        }

        .delete-confirmation h3 {
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .delete-confirmation p {
            color: var(--text-light);
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <button class="mobile-menu-toggle" id="mobileMenuToggle"><i class="fas fa-bars"></i></button>

    <div class="app-container">
        <!-- Left Sidebar - Icons Only -->
        <aside class="sidebar" id="sidebar">
            <div class="logo"><i class="fas fa-chalkboard-teacher"></i></div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><i class="fas fa-home"></i><span class="tooltip">Dashboard</span></a>
                    </li>
                    <li><a href="bench.html"><i class="fas fa-book-open"></i><span class="tooltip">Benches</span></a>
                    </li>
                    <li><a href="#" class="active"><i class="fas fa-graduation-cap"></i><span
                                class="tooltip">Learn</span></a></li>
                    <li><a href="chat.html"><i class="fas fa-comments"></i><span class="tooltip">Chat</span></a></li>
                    <li><a href="tools.html"><i class="fas fa-tools"></i><span class="tooltip">Tools</span></a></li>
                    <li><a href="settings.html"><i class="fas fa-cog"></i><span class="tooltip">Settings</span></a></li>
                    <li><a href="profile.html"><i class="fas fa-user-circle"></i><span
                                class="tooltip">Profile</span></a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Learning View Container -->
            <div class="learning-view-container">
                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button class="tab-btn active" data-tab="my-lessons">
                        <i class="fas fa-book"></i> My Lessons
                    </button>
                    <button class="tab-btn" data-tab="shared-lessons">
                        <i class="fas fa-share-alt"></i> Shared With Me
                    </button>
                </div>

                <!-- My Lessons Tab Content -->
                <div class="tab-content active" id="my-lessons">
                    <div class="learning-list-view">
                        <div class="learning-actions">
                            <button class="action-btn" id="createLessonBtn">
                                <i class="fas fa-plus"></i> Create Lesson
                            </button>
                        </div>
                        <div class="lessons-grid" id="myLessonsList">
                            <!-- Lesson cards will be injected by JS from Firebase -->
                        </div>
                    </div>
                </div>

                <!-- Shared Lessons Tab Content -->
                <div class="tab-content" id="shared-lessons">
                    <div class="learning-list-view">
                        <div class="lessons-grid" id="sharedLessonsList">
                            <!-- Shared lesson cards will be injected by JS from Firebase -->
                        </div>
                    </div>
                </div>

                <!-- Lesson Detail View -->
                <div class="lesson-detail-view" id="lessonDetailView">
                    <!-- Lesson Header -->
                    <div class="lesson-header">
                        <h2 id="lessonName">Lesson Name</h2>
                        <div class="lesson-actions">
                            <button class="action-btn-small" id="exportLessonBtn">
                                <i class="fas fa-file-pdf"></i> Export
                            </button>
                            <button class="action-btn-small" id="shareLessonBtn">
                                <i class="fas fa-share-alt"></i> Share
                            </button>
                            <button class="action-btn-small" id="editLessonBtn">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn-small delete-btn" id="deleteLessonBtn">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            <button class="close-btn" id="closeLessonBtn">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>

                    <!-- Breadcrumb Navigation -->
                    <div class="breadcrumb-nav" id="breadcrumbNav">
                        <!-- Breadcrumb items will be generated dynamically -->
                    </div>

                    <div class="lesson-content">
                        <div class="navigation-panel">
                            <ul class="nav-tree" id="navTree">
                                <!-- Navigation tree will be generated dynamically -->
                            </ul>
                            <button class="add-btn" id="addTopicBtn">
                                <i class="fas fa-plus"></i> Add Topic
                            </button>
                        </div>
                        <div class="content-area">
                            <div class="content-header">
                                <h3 id="contentTitle">Lesson Overview</h3>
                                <div class="content-actions" id="contentActions">
                                    <!-- Content action buttons will be added dynamically -->
                                </div>
                            </div>
                            <div class="content-body" id="contentBody">
                                <!-- Content will be loaded based on selected item -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" id="fabBtn">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="edit">
            <i class="fas fa-edit"></i> Edit
        </div>
        <div class="context-menu-item" data-action="delete">
            <i class="fas fa-trash"></i> Delete
        </div>
    </div>

    <!-- Create Lesson Modal -->
    <div class="modal" id="createLessonModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Lesson</h3>
                <button class="modal-close" id="closeCreateLessonModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="lessonNameInput">Lesson Name</label>
                    <input type="text" id="lessonNameInput" placeholder="Enter lesson name">
                </div>
                <div class="form-group">
                    <label for="lessonDescInput">Description (Optional)</label>
                    <textarea id="lessonDescInput" placeholder="Enter lesson description"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCreateLessonBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmCreateLessonBtn">Create</button>
            </div>
        </div>
    </div>

    <!-- Edit Lesson Modal -->
    <div class="modal" id="editLessonModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Lesson</h3>
                <button class="modal-close" id="closeEditLessonModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="edit-form">
                    <div class="form-group">
                        <label for="editLessonNameInput">Lesson Name</label>
                        <input type="text" id="editLessonNameInput" placeholder="Enter lesson name">
                    </div>
                    <div class="form-group">
                        <label for="editLessonDescInput">Description (Optional)</label>
                        <textarea id="editLessonDescInput" placeholder="Enter lesson description"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditLessonBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmEditLessonBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="deleteModalTitle">Confirm Delete</h3>
                <button class="modal-close" id="closeDeleteModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="delete-confirmation">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Are you sure?</h3>
                    <p id="deleteModalMessage">This action cannot be undone.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Add Topic Modal -->
    <div class="modal" id="addTopicModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Topic</h3>
                <button class="modal-close" id="closeAddTopicModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="topicNameInput">Topic Name</label>
                    <input type="text" id="topicNameInput" placeholder="Enter topic name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelAddTopicBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmAddTopicBtn">Add</button>
            </div>
        </div>
    </div>

    <!-- Edit Topic Modal -->
    <div class="modal" id="editTopicModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Topic</h3>
                <button class="modal-close" id="closeEditTopicModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editTopicNameInput">Topic Name</label>
                    <input type="text" id="editTopicNameInput" placeholder="Enter topic name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditTopicBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmEditTopicBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Content Modal -->
    <div class="modal" id="addContentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="addContentTitle">Add Content</h3>
                <button class="modal-close" id="closeAddContentModal">&times;</button>
            </div>
            <div class="modal-body" id="addContentBody">
                <!-- Content will be added dynamically based on content type -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelAddContentBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmAddContentBtn">Add</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Share Lesson</h3>
                <button class="modal-close" id="closeShareModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="share-options">
                    <div class="share-option" data-share-type="profile">
                        <div class="share-option-header">
                            <i class="fas fa-user-circle"></i>
                            <div class="share-option-title">Share to Profile</div>
                        </div>
                        <div class="share-option-description">Share this lesson directly to a user's profile</div>
                        <div class="share-details" style="display: none;">
                            <div class="form-group">
                                <label for="shareUsernameInput">Username</label>
                                <input type="text" id="shareUsernameInput" placeholder="Enter username">
                            </div>
                            <div class="access-level">
                                <div class="access-option" data-access="read">Read Only</div>
                                <div class="access-option" data-access="edit">Can Edit</div>
                            </div>
                        </div>
                    </div>
                    <div class="share-option" data-share-type="bench">
                        <div class="share-option-header">
                            <i class="fas fa-book-open"></i>
                            <div class="share-option-title">Share to Bench</div>
                        </div>
                        <div class="share-option-description">Share this lesson to a bench you've joined</div>
                        <div class="share-details" style="display: none;">
                            <div class="form-group">
                                <label for="shareBenchSelect">Select Bench</label>
                                <select id="shareBenchSelect">
                                    <option value="">Select a bench</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                            <div class="access-level">
                                <div class="access-option" data-access="read">Read Only</div>
                                <div class="access-option" data-access="edit">Can Edit</div>
                            </div>
                        </div>
                    </div>
                    <div class="share-option" data-share-type="link">
                        <div class="share-option-header">
                            <i class="fas fa-link"></i>
                            <div class="share-option-title">Share Link</div>
                        </div>
                        <div class="share-option-description">Generate a shareable link for this lesson</div>
                        <div class="share-details" style="display: none;">
                            <div class="form-group">
                                <label for="shareLinkInput">Share Link</label>
                                <input type="text" id="shareLinkInput" readonly>
                            </div>
                            <div class="access-level">
                                <div class="access-option" data-access="read">Read Only</div>
                                <div class="access-option" data-access="edit">Can Edit</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelShareBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmShareBtn">Share</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA-a6qP2kDNCdVv0zRl2AQYJ3QTNe18cYA",
            authDomain: "mindset-94cb1.firebaseapp.com",
            projectId: "mindset-94cb1",
            storageBucket: "mindset-94cb1.firebasestorage.app",
            messagingSenderId: "1070543818778",
            appId: "1:1070543818778:web:39414a72999678399ac1a3",
            databaseURL: "https://mindset-94cb1-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let currentUser = null;
        let currentLesson = null;
        let currentTopic = null;
        let currentSubtopic = null;
        let sharedLessons = [];
        let deleteTarget = null;
        let deleteType = null;

        // Gradient options for lessons
        const gradientOptions = [
            'var(--gradient-primary)',
            'var(--gradient-secondary)',
            'var(--gradient-accent)',
            'var(--gradient-success)',
            'var(--gradient-info)',
            'var(--gradient-warning)'
        ];

        // Check authentication state
        function checkAuthState() {
            const userSession = JSON.parse(localStorage.getItem('mindsetUser'));
            if (!userSession) {
                window.location.href = 'index.html';
                return;
            }

            if (!userSession.id) {
                database.ref('users').orderByChild('username').equalTo(userSession.username).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            userSession.id = childSnapshot.key;
                            localStorage.setItem('mindsetUser', JSON.stringify(userSession));
                            currentUser = userSession;
                            initializeLearning();
                        });
                    } else {
                        localStorage.removeItem('mindsetUser');
                        window.location.href = 'index.html';
                    }
                });
            } else {
                currentUser = userSession;
                initializeLearning();
            }
        }

        // Initialize learning page
        function initializeLearning() {
            loadMyLessons();
            loadSharedLessons();
            setupEventListeners();
            setupRealtimeUpdates();
        }

        // Setup real-time updates
        function setupRealtimeUpdates() {
            // Listen for changes in user's lessons
            database.ref('lessons').orderByChild('createdBy').equalTo(currentUser.id).on('value', (snapshot) => {
                if (document.getElementById('my-lessons').classList.contains('active')) {
                    loadMyLessons();
                }
            });

            // Listen for changes in shared lessons
            database.ref(`users/${currentUser.id}/sharedLessons`).on('value', (snapshot) => {
                if (document.getElementById('shared-lessons').classList.contains('active')) {
                    loadSharedLessons();
                }
            });
        }

        // Load my lessons from Firebase
        function loadMyLessons() {
            const lessonsList = document.getElementById('myLessonsList');
            lessonsList.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">Loading lessons...</div></div>';

            database.ref('lessons').orderByChild('createdBy').equalTo(currentUser.id).once('value')
                .then(snapshot => {
                    lessonsList.innerHTML = '';
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const lesson = childSnapshot.val();
                            const lessonId = childSnapshot.key;
                            const topicCount = lesson.topics ? Object.keys(lesson.topics).length : 0;

                            // Assign a random gradient if not already assigned
                            const gradientClass = lesson.gradientClass || gradientOptions[Math.floor(Math.random() * gradientOptions.length)];

                            // Save the gradient class to Firebase if not already saved
                            if (!lesson.gradientClass) {
                                database.ref(`lessons/${lessonId}/gradientClass`).set(gradientClass);
                            }

                            const card = document.createElement('div');
                            card.className = 'lesson-card';
                            card.style.background = gradientClass;
                            card.dataset.lessonId = lessonId;
                            card.innerHTML = `
                                <h3>${lesson.title}</h3>
                                <p>${lesson.description || 'No description available'}</p>
                                <div class="lesson-meta">
                                    <div class="topic-count">
                                        <i class="fas fa-file-alt"></i>
                                        <span>${topicCount}</span> topics
                                    </div>
                                </div>
                            `;

                            // Make the entire card clickable
                            card.addEventListener('click', (e) => {
                                if (!e.target.closest('.lesson-actions')) {
                                    openLesson(lessonId);
                                }
                            });

                            // Add context menu
                            card.addEventListener('contextmenu', (e) => {
                                e.preventDefault();
                                showContextMenu(e, 'lesson', lessonId);
                            });

                            lessonsList.appendChild(card);
                        });
                    } else {
                        lessonsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-book-open"></i>
                                <h3>No lessons created yet</h3>
                                <p>Create your first lesson to get started!</p>
                                <button class="action-btn" id="emptyCreateLessonBtn">
                                    <i class="fas fa-plus"></i> Create Lesson
                                </button>
                            </div>
                        `;

                        // Add event listener to the empty state button
                        document.getElementById('emptyCreateLessonBtn').addEventListener('click', () => {
                            document.getElementById('createLessonModal').classList.add('active');
                        });
                    }
                })
                .catch(error => {
                    console.error("Error loading lessons:", error);
                    lessonsList.innerHTML = '<p style="text-align:center; color: red;">Error loading lessons.</p>';
                });
        }

        // Load shared lessons from Firebase
        function loadSharedLessons() {
            const lessonsList = document.getElementById('sharedLessonsList');
            lessonsList.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">Loading shared lessons...</div></div>';

            database.ref(`users/${currentUser.id}/sharedLessons`).once('value')
                .then(snapshot => {
                    lessonsList.innerHTML = '';
                    if (snapshot.exists()) {
                        sharedLessons = [];
                        const sharedLessonIds = Object.keys(snapshot.val());

                        // Load each shared lesson
                        Promise.all(sharedLessonIds.map(lessonId => {
                            return database.ref(`lessons/${lessonId}`).once('value');
                        }))
                            .then(results => {
                                results.forEach(childSnapshot => {
                                    if (childSnapshot.exists()) {
                                        const lesson = childSnapshot.val();
                                        const lessonId = childSnapshot.key;
                                        const shareInfo = snapshot.val()[lessonId];
                                        const topicCount = lesson.topics ? Object.keys(lesson.topics).length : 0;

                                        // Get shared by user info
                                        database.ref(`users/${shareInfo.sharedBy}`).once('value')
                                            .then(userSnapshot => {
                                                const sharedByUser = userSnapshot.val();
                                                const sharedByUsername = sharedByUser ? sharedByUser.username : 'Unknown';

                                                // Assign a random gradient if not already assigned
                                                const gradientClass = lesson.gradientClass || gradientOptions[Math.floor(Math.random() * gradientOptions.length)];

                                                const card = document.createElement('div');
                                                card.className = 'lesson-card';
                                                card.style.background = gradientClass;
                                                card.dataset.lessonId = lessonId;
                                                card.innerHTML = `
                                                <h3>${lesson.title}</h3>
                                                <p>${lesson.description || 'No description available'}</p>
                                                <div class="lesson-meta">
                                                    <div class="topic-count">
                                                        <i class="fas fa-file-alt"></i>
                                                        <span>${topicCount}</span> topics
                                                    </div>
                                                    <div class="shared-by">
                                                        <i class="fas fa-user"></i>
                                                        <span>${sharedByUsername}</span>
                                                    </div>
                                                </div>
                                            `;

                                                // Make the entire card clickable
                                                card.addEventListener('click', (e) => {
                                                    if (!e.target.closest('.lesson-actions')) {
                                                        openSharedLesson(lessonId, shareInfo);
                                                    }
                                                });

                                                lessonsList.appendChild(card);
                                            });
                                    }
                                });
                            })
                            .catch(error => {
                                console.error("Error loading shared lessons:", error);
                                lessonsList.innerHTML = '<p style="text-align:center; color: red;">Error loading shared lessons.</p>';
                            });
                    } else {
                        lessonsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-share-alt"></i>
                                <h3>No shared lessons</h3>
                                <p>Lessons shared with you will appear here.</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error("Error loading shared lessons:", error);
                    lessonsList.innerHTML = '<p style="text-align:center; color: red;">Error loading shared lessons.</p>';
                });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;

                    // Update active tab button
                    document.querySelectorAll('.tab-btn').forEach(tabBtn => {
                        tabBtn.classList.remove('active');
                    });
                    btn.classList.add('active');

                    // Update active tab content
                    document.querySelectorAll('.tab-content').forEach(tabContent => {
                        tabContent.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // Floating Action Button
            document.getElementById('fabBtn').addEventListener('click', () => {
                document.getElementById('createLessonModal').classList.add('active');
            });

            // Create Lesson Modal
            document.getElementById('createLessonBtn').addEventListener('click', () => {
                document.getElementById('createLessonModal').classList.add('active');
            });

            document.getElementById('closeCreateLessonModal').addEventListener('click', () => {
                document.getElementById('createLessonModal').classList.remove('active');
            });

            document.getElementById('cancelCreateLessonBtn').addEventListener('click', () => {
                document.getElementById('createLessonModal').classList.remove('active');
            });

            document.getElementById('confirmCreateLessonBtn').addEventListener('click', createLesson);

            // Edit Lesson Modal
            document.getElementById('editLessonBtn').addEventListener('click', () => {
                openEditLessonModal();
            });

            document.getElementById('closeEditLessonModal').addEventListener('click', () => {
                document.getElementById('editLessonModal').classList.remove('active');
            });

            document.getElementById('cancelEditLessonBtn').addEventListener('click', () => {
                document.getElementById('editLessonModal').classList.remove('active');
            });

            document.getElementById('confirmEditLessonBtn').addEventListener('click', updateLesson);

            // Delete Lesson
            document.getElementById('deleteLessonBtn').addEventListener('click', () => {
                openDeleteModal('lesson', currentLesson.id, 'Are you sure you want to delete this lesson? This will also delete all topics and subtopics within it.');
            });

            // Delete Modal
            document.getElementById('closeDeleteModal').addEventListener('click', () => {
                document.getElementById('deleteModal').classList.remove('active');
            });

            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                document.getElementById('deleteModal').classList.remove('active');
            });

            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);

            // Add Topic Modal
            document.getElementById('addTopicBtn').addEventListener('click', () => {
                document.getElementById('addTopicModal').classList.add('active');
            });

            document.getElementById('closeAddTopicModal').addEventListener('click', () => {
                document.getElementById('addTopicModal').classList.remove('active');
            });

            document.getElementById('cancelAddTopicBtn').addEventListener('click', () => {
                document.getElementById('addTopicModal').classList.remove('active');
            });

            document.getElementById('confirmAddTopicBtn').addEventListener('click', addTopic);

            // Edit Topic Modal
            document.getElementById('closeEditTopicModal').addEventListener('click', () => {
                document.getElementById('editTopicModal').classList.remove('active');
            });

            document.getElementById('cancelEditTopicBtn').addEventListener('click', () => {
                document.getElementById('editTopicModal').classList.remove('active');
            });

            document.getElementById('confirmEditTopicBtn').addEventListener('click', updateTopic);

            // Add Content Modal
            document.getElementById('closeAddContentModal').addEventListener('click', () => {
                document.getElementById('addContentModal').classList.remove('active');
            });

            document.getElementById('cancelAddContentBtn').addEventListener('click', () => {
                document.getElementById('addContentModal').classList.remove('active');
            });

            document.getElementById('confirmAddContentBtn').addEventListener('click', addContent);

            // Export Lesson
            document.getElementById('exportLessonBtn').addEventListener('click', exportLesson);

            // Share Modal
            document.getElementById('shareLessonBtn').addEventListener('click', () => {
                openShareModal();
            });

            document.getElementById('closeShareModal').addEventListener('click', () => {
                document.getElementById('shareModal').classList.remove('active');
            });

            document.getElementById('cancelShareBtn').addEventListener('click', () => {
                document.getElementById('shareModal').classList.remove('active');
            });

            document.getElementById('confirmShareBtn').addEventListener('click', shareLesson);

            // Close Lesson
            document.getElementById('closeLessonBtn').addEventListener('click', closeLesson);

            // Share options
            document.querySelectorAll('.share-option').forEach(option => {
                option.addEventListener('click', () => {
                    // Toggle active state
                    document.querySelectorAll('.share-option').forEach(opt => {
                        opt.classList.remove('active');
                        opt.querySelector('.share-details').style.display = 'none';
                    });

                    option.classList.add('active');
                    option.querySelector('.share-details').style.display = 'block';

                    // Load benches if sharing to bench
                    if (option.dataset.shareType === 'bench') {
                        loadBenchesForShare();
                    }

                    // Generate share link if sharing by link
                    if (option.dataset.shareType === 'link') {
                        generateShareLink();
                    }
                });
            });

            // Access level options
            document.querySelectorAll('.access-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.access-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    option.classList.add('active');
                });
            });

            // Context menu
            document.addEventListener('click', () => {
                hideContextMenu();
            });

            document.querySelectorAll('.context-menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const action = item.dataset.action;
                    const type = deleteTarget.type;
                    const id = deleteTarget.id;

                    if (action === 'edit') {
                        if (type === 'lesson') {
                            openEditLessonModal();
                        } else if (type === 'topic') {
                            openEditTopicModal(id);
                        }
                    } else if (action === 'delete') {
                        if (type === 'lesson') {
                            openDeleteModal('lesson', id, 'Are you sure you want to delete this lesson? This will also delete all topics and subtopics within it.');
                        } else if (type === 'topic') {
                            openDeleteModal('topic', id, 'Are you sure you want to delete this topic? This will also delete all subtopics within it.');
                        } else if (type === 'subtopic') {
                            openDeleteModal('subtopic', id, 'Are you sure you want to delete this subtopic?');
                        }
                    }

                    hideContextMenu();
                });
            });

            // Mobile Menu Toggle
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');

            mobileMenuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });

            document.querySelector('.main-content').addEventListener('click', () => {
                if (window.innerWidth <= 1024) {
                    sidebar.classList.remove('active');
                }
            });
        }

        // Show context menu
        function showContextMenu(event, type, id) {
            const contextMenu = document.getElementById('contextMenu');
            deleteTarget = { type, id };

            contextMenu.style.left = `${event.pageX}px`;
            contextMenu.style.top = `${event.pageY}px`;
            contextMenu.classList.add('active');
        }

        // Hide context menu
        function hideContextMenu() {
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.classList.remove('active');
        }

        // Open edit lesson modal
        function openEditLessonModal() {
            document.getElementById('editLessonNameInput').value = currentLesson.title;
            document.getElementById('editLessonDescInput').value = currentLesson.description || '';
            document.getElementById('editLessonModal').classList.add('active');
        }

        // Update lesson
        function updateLesson() {
            const lessonName = document.getElementById('editLessonNameInput').value.trim();
            const lessonDesc = document.getElementById('editLessonDescInput').value.trim();

            if (!lessonName) {
                showNotification('Please enter a lesson name', 'error');
                return;
            }

            database.ref(`lessons/${currentLesson.id}`).update({
                title: lessonName,
                description: lessonDesc,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            })
                .then(() => {
                    document.getElementById('editLessonModal').classList.remove('active');
                    currentLesson.title = lessonName;
                    currentLesson.description = lessonDesc;
                    document.getElementById('lessonName').textContent = lessonName;
                    showNotification('Lesson updated successfully!');
                })
                .catch(error => {
                    console.error("Error updating lesson:", error);
                    showNotification('Error updating lesson. Please try again.', 'error');
                });
        }

        // Open edit topic modal
        function openEditTopicModal(topicId) {
            const topic = currentLesson.topics[topicId];
            document.getElementById('editTopicNameInput').value = topic.title;
            document.getElementById('editTopicModal').classList.add('active');
            document.getElementById('editTopicModal').dataset.topicId = topicId;
        }

        // Update topic
        function updateTopic() {
            const topicName = document.getElementById('editTopicNameInput').value.trim();
            const topicId = document.getElementById('editTopicModal').dataset.topicId;

            if (!topicName) {
                showNotification('Please enter a topic name', 'error');
                return;
            }

            database.ref(`lessons/${currentLesson.id}/topics/${topicId}`).update({
                title: topicName,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            })
                .then(() => {
                    document.getElementById('editTopicModal').classList.remove('active');
                    currentLesson.topics[topicId].title = topicName;
                    loadNavigationTree();
                    loadLessonOverview();
                    showNotification('Topic updated successfully!');
                })
                .catch(error => {
                    console.error("Error updating topic:", error);
                    showNotification('Error updating topic. Please try again.', 'error');
                });
        }

        // Open delete modal
        function openDeleteModal(type, id, message) {
            deleteType = type;
            deleteTarget = { type, id };
            document.getElementById('deleteModalMessage').textContent = message;
            document.getElementById('deleteModal').classList.add('active');
        }

        // Confirm delete
        function confirmDelete() {
            const type = deleteType;
            const id = deleteTarget.id;

            let refPath;
            let successMessage;

            switch (type) {
                case 'lesson':
                    refPath = `lessons/${id}`;
                    successMessage = 'Lesson deleted successfully!';
                    break;
                case 'topic':
                    refPath = `lessons/${currentLesson.id}/topics/${id}`;
                    successMessage = 'Topic deleted successfully!';
                    break;
                case 'subtopic':
                    refPath = `lessons/${currentLesson.id}/topics/${currentTopic.id}/subtopics/${id}`;
                    successMessage = 'Subtopic deleted successfully!';
                    break;
            }

            database.ref(refPath).remove()
                .then(() => {
                    document.getElementById('deleteModal').classList.remove('active');
                    showNotification(successMessage);

                    // Reload appropriate view
                    if (type === 'lesson') {
                        closeLesson();
                        loadMyLessons();
                    } else {
                        // Reload lesson data
                        database.ref(`lessons/${currentLesson.id}`).once('value')
                            .then(snapshot => {
                                currentLesson = {
                                    id: currentLesson.id,
                                    ...snapshot.val()
                                };
                                loadNavigationTree();
                                loadLessonOverview();
                            });
                    }
                })
                .catch(error => {
                    console.error("Error deleting:", error);
                    showNotification('Error deleting. Please try again.', 'error');
                });
        }

        // Create a new lesson
        function createLesson() {
            const lessonName = document.getElementById('lessonNameInput').value.trim();
            const lessonDesc = document.getElementById('lessonDescInput').value.trim();

            if (!lessonName) {
                showNotification('Please enter a lesson name', 'error');
                return;
            }

            // Assign a random gradient
            const gradientClass = gradientOptions[Math.floor(Math.random() * gradientOptions.length)];

            // Create lesson in Firebase
            const newLessonRef = database.ref('lessons').push();
            const lessonId = newLessonRef.key;

            newLessonRef.set({
                title: lessonName,
                description: lessonDesc,
                createdBy: currentUser.id,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                gradientClass: gradientClass,
                topics: {}
            })
                .then(() => {
                    // Clear form and close modal
                    document.getElementById('lessonNameInput').value = '';
                    document.getElementById('lessonDescInput').value = '';
                    document.getElementById('createLessonModal').classList.remove('active');

                    // Reload lessons
                    loadMyLessons();

                    // Show success message
                    showNotification('Lesson created successfully!');
                })
                .catch(error => {
                    console.error("Error creating lesson:", error);
                    showNotification('Error creating lesson. Please try again.', 'error');
                });
        }

        // Open a lesson
        function openLesson(lessonId) {
            // Show loading state
            document.getElementById('my-lessons').style.display = 'none';
            document.getElementById('shared-lessons').style.display = 'none';
            document.querySelector('.tab-navigation').style.display = 'none';
            document.getElementById('lessonDetailView').style.display = 'flex';
            document.getElementById('contentBody').innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">Loading lesson...</div></div>';

            // Get lesson details
            database.ref(`lessons/${lessonId}`).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        currentLesson = {
                            id: lessonId,
                            ...snapshot.val()
                        };

                        // Apply theme background color
                        document.getElementById('lessonDetailView').style.background = currentLesson.gradientClass;

                        // Update lesson header
                        document.getElementById('lessonName').textContent = currentLesson.title;

                        // Update breadcrumb
                        updateBreadcrumb('lesson', currentLesson.title);

                        // Load navigation tree
                        loadNavigationTree();

                        // Load lesson overview content
                        loadLessonOverview();
                    }
                })
                .catch(error => {
                    console.error("Error opening lesson:", error);
                    showNotification('Error opening lesson. Please try again.', 'error');
                });
        }

        // Open a shared lesson
        function openSharedLesson(lessonId, shareInfo) {
            // Show loading state
            document.getElementById('my-lessons').style.display = 'none';
            document.getElementById('shared-lessons').style.display = 'none';
            document.querySelector('.tab-navigation').style.display = 'none';
            document.getElementById('lessonDetailView').style.display = 'flex';
            document.getElementById('contentBody').innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">Loading lesson...</div></div>';

            // Get lesson details
            database.ref(`lessons/${lessonId}`).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        currentLesson = {
                            id: lessonId,
                            ...snapshot.val(),
                            shared: true,
                            accessLevel: shareInfo.accessLevel
                        };

                        // Apply theme background color
                        document.getElementById('lessonDetailView').style.background = currentLesson.gradientClass;

                        // Update lesson header
                        document.getElementById('lessonName').textContent = currentLesson.title;

                        // Update breadcrumb
                        updateBreadcrumb('lesson', currentLesson.title);

                        // Load navigation tree
                        loadNavigationTree();

                        // Load lesson overview content
                        loadLessonOverview();

                        // Disable edit buttons if read-only access
                        if (shareInfo.accessLevel === 'read') {
                            document.getElementById('editLessonBtn').style.display = 'none';
                            document.getElementById('deleteLessonBtn').style.display = 'none';
                            document.getElementById('addTopicBtn').style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error("Error opening shared lesson:", error);
                    showNotification('Error opening lesson. Please try again.', 'error');
                });
        }

        // Close lesson
        function closeLesson() {
            // Show lesson list view
            document.getElementById('my-lessons').style.display = 'flex';
            document.getElementById('shared-lessons').style.display = 'none';
            document.querySelector('.tab-navigation').style.display = 'flex';
            document.getElementById('lessonDetailView').style.display = 'none';

            // Reset current lesson
            currentLesson = null;
        }

        // Update breadcrumb navigation
        function updateBreadcrumb(type, name, parentId = null, parentName = null) {
            const breadcrumbNav = document.getElementById('breadcrumbNav');
            breadcrumbNav.innerHTML = '';

            // Add lesson breadcrumb
            const lessonBreadcrumb = document.createElement('div');
            lessonBreadcrumb.className = 'breadcrumb-item';
            lessonBreadcrumb.innerHTML = `
                <i class="fas fa-book"></i>
                <span>${currentLesson.title.length > 20 ? currentLesson.title.substring(0, 20) + '...' : currentLesson.title}</span>
            `;
            breadcrumbNav.appendChild(lessonBreadcrumb);

            if (type === 'lesson') {
                lessonBreadcrumb.classList.add('active');
                return;
            }

            // Add separator
            const separator1 = document.createElement('div');
            separator1.className = 'breadcrumb-separator';
            separator1.innerHTML = '<i class="fas fa-chevron-right"></i>';
            breadcrumbNav.appendChild(separator1);

            // Add topic breadcrumb
            const topicBreadcrumb = document.createElement('div');
            topicBreadcrumb.className = 'breadcrumb-item';
            topicBreadcrumb.innerHTML = `
                <i class="fas fa-file-alt"></i>
                <span>${name.length > 15 ? name.substring(0, 15) + '...' : name}</span>
            `;
            breadcrumbNav.appendChild(topicBreadcrumb);

            if (type === 'topic') {
                topicBreadcrumb.classList.add('active');
                return;
            }

            // Add separator
            const separator2 = document.createElement('div');
            separator2.className = 'breadcrumb-separator';
            separator2.innerHTML = '<i class="fas fa-chevron-right"></i>';
            breadcrumbNav.appendChild(separator2);

            // Add subtopic breadcrumb
            const subtopicBreadcrumb = document.createElement('div');
            subtopicBreadcrumb.className = 'breadcrumb-item active';
            subtopicBreadcrumb.innerHTML = `
                <i class="fas fa-sticky-note"></i>
                <span>${name.length > 15 ? name.substring(0, 15) + '...' : name}</span>
            `;
            breadcrumbNav.appendChild(subtopicBreadcrumb);
        }

        // Load navigation tree with branch system
        function loadNavigationTree() {
            const navTree = document.getElementById('navTree');
            navTree.innerHTML = '';

            // Add lesson item as root node
            const lessonItem = document.createElement('li');
            lessonItem.innerHTML = `
                <div class="nav-item active" data-type="lesson" data-id="${currentLesson.id}">
                    <i class="fas fa-book"></i>
                    <span>${currentLesson.title}</span>
                </div>
            `;
            navTree.appendChild(lessonItem);

            // Add topics as branches
            if (currentLesson.topics) {
                const topicsList = document.createElement('ul');
                topicsList.className = 'nav-children';

                Object.keys(currentLesson.topics).forEach(topicId => {
                    const topic = currentLesson.topics[topicId];

                    const topicItem = document.createElement('li');
                    topicItem.innerHTML = `
                        <div class="nav-item" data-type="topic" data-id="${topicId}">
                            <i class="fas fa-file-alt"></i>
                            <span>${topic.title}</span>
                        </div>
                    `;

                    // Add context menu for topics
                    topicItem.querySelector('.nav-item').addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!currentLesson.shared || currentLesson.accessLevel === 'edit') {
                            showContextMenu(e, 'topic', topicId);
                        }
                    });

                    // Add subtopics as sub-branches
                    if (topic.subtopics) {
                        const subtopicsList = document.createElement('ul');
                        subtopicsList.className = 'nav-children';

                        Object.keys(topic.subtopics).forEach(subtopicId => {
                            const subtopic = topic.subtopics[subtopicId];

                            const subtopicItem = document.createElement('li');
                            subtopicItem.innerHTML = `
                                <div class="nav-item" data-type="subtopic" data-id="${subtopicId}" data-topic="${topicId}">
                                    <i class="fas fa-sticky-note"></i>
                                    <span>${subtopic.title}</span>
                                </div>
                            `;

                            // Add context menu for subtopics
                            subtopicItem.querySelector('.nav-item').addEventListener('contextmenu', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                if (!currentLesson.shared || currentLesson.accessLevel === 'edit') {
                                    showContextMenu(e, 'subtopic', subtopicId);
                                }
                            });

                            subtopicsList.appendChild(subtopicItem);
                        });

                        // Add "Add Subtopic" button
                        if (!currentLesson.shared || currentLesson.accessLevel === 'edit') {
                            const addSubtopicItem = document.createElement('li');
                            addSubtopicItem.innerHTML = `
                                <div class="add-btn add-subtopic-btn" data-topic="${topicId}">
                                    <i class="fas fa-plus"></i>
                                </div>
                            `;
                            subtopicsList.appendChild(addSubtopicItem);
                        }

                        topicItem.appendChild(subtopicsList);
                    }

                    topicsList.appendChild(topicItem);
                });

                navTree.appendChild(topicsList);
            }

            // Add event listeners for navigation items
            setupNavigationListeners(navTree);
        }

        // Setup navigation listeners
        function setupNavigationListeners(container) {
            container.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const type = item.dataset.type;
                    const id = item.dataset.id;
                    const topicId = item.dataset.topic;

                    // Update active state
                    container.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    item.classList.add('active');

                    // Load content based on type
                    if (type === 'lesson') {
                        loadLessonOverview();
                    } else if (type === 'topic') {
                        loadTopic(id);
                    } else if (type === 'subtopic') {
                        loadSubtopic(topicId, id);
                    }
                });
            });

            // Add subtopic buttons
            container.querySelectorAll('.add-subtopic-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const topicId = btn.dataset.topic;
                    showAddContentModal('subtopic', topicId);
                });
            });
        }

        // Load lesson overview content
        function loadLessonOverview() {
            updateBreadcrumb('lesson', currentLesson.title);

            document.getElementById('contentTitle').textContent = 'Lesson Overview';

            const contentActions = document.getElementById('contentActions');

            if (!currentLesson.shared || currentLesson.accessLevel === 'edit') {
                contentActions.innerHTML = `
                    <button class="content-action-btn" id="editLessonOverviewBtn">
                        <i class="fas fa-edit"></i>
                    </button>
                `;
            } else {
                contentActions.innerHTML = '';
            }

            if (document.getElementById('editLessonOverviewBtn')) {
                document.getElementById('editLessonOverviewBtn').addEventListener('click', () => {
                    openEditLessonModal();
                });
            }

            const contentBody = document.getElementById('contentBody');
            contentBody.innerHTML = `
                <div class="content-text">
                    <h4>Description</h4>
                    <p>${currentLesson.description || 'No description available'}</p>
                    
                    <h4 style="margin-top: 20px;">Topics</h4>
                    <div id="topicsList">
                        <p>Loading topics...</p>
                    </div>
                </div>
            `;

            // Load topics
            loadTopicsList();
        }

        // Load topics list
        function loadTopicsList() {
            const topicsList = document.getElementById('topicsList');

            if (currentLesson.topics) {
                topicsList.innerHTML = '';

                Object.keys(currentLesson.topics).forEach(topicId => {
                    const topic = currentLesson.topics[topicId];

                    const topicItem = document.createElement('div');
                    topicItem.className = 'gradient-card cool';
                    topicItem.style.cssText = 'margin-bottom: 10px; cursor: pointer; padding: 10px; background: var(--bg-light); border-radius: var(--radius-md);';
                    topicItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0; color: var(--text-dark);">${topic.title}</h4>
                            </div>
                            ${!currentLesson.shared || currentLesson.accessLevel === 'edit' ? `
                                <div style="display: flex; gap: 5px;">
                                    <button class="content-action-btn" onclick="openEditTopicModal('${topicId}')" style="padding: 5px 10px;">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="content-action-btn delete-btn" onclick="openDeleteModal('topic', '${topicId}', 'Are you sure you want to delete this topic? This will also delete all subtopics within it.')" style="padding: 5px 10px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;

                    topicItem.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            loadTopic(topicId);
                        }
                    });

                    topicsList.appendChild(topicItem);
                });
            } else {
                topicsList.innerHTML = '<p>No topics yet. Add a topic to get started!</p>';
            }
        }

        // Load topic content
        function loadTopic(topicId) {
            const topic = currentLesson.topics[topicId];
            currentTopic = {
                id: topicId,
                ...topic
            };

            updateBreadcrumb('topic', topic.title);

            document.getElementById('contentTitle').textContent = topic.title;

            const contentActions = document.getElementById('contentActions');

            if (!currentLesson.shared || currentLesson.accessLevel === 'edit') {
                contentActions.innerHTML = `
                    <button class="content-action-btn" id="addSubtopicBtn">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="content-action-btn" id="addNoteBtn">
                        <i class="fas fa-sticky-note"></i>
                    </button>
                    <button class="content-action-btn" id="addLinkBtn">
                        <i class="fas fa-link"></i>
                    </button>
                    <button class="content-action-btn" id="addImageBtn">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="content-action-btn delete-btn" id="deleteTopicBtn">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            } else {
                contentActions.innerHTML = '';
            }

            // Setup content action buttons
            if (document.getElementById('addSubtopicBtn')) {
                document.getElementById('addSubtopicBtn').addEventListener('click', () => {
                    showAddContentModal('subtopic', topicId);
                });
            }

            if (document.getElementById('addNoteBtn')) {
                document.getElementById('addNoteBtn').addEventListener('click', () => {
                    showAddContentModal('note', topicId);
                });
            }

            if (document.getElementById('addLinkBtn')) {
                document.getElementById('addLinkBtn').addEventListener('click', () => {
                    showAddContentModal('link', topicId);
                });
            }

            if (document.getElementById('addImageBtn')) {
                document.getElementById('addImageBtn').addEventListener('click', () => {
                    showAddContentModal('image', topicId);
                });
            }

            if (document.getElementById('deleteTopicBtn')) {
                document.getElementById('deleteTopicBtn').addEventListener('click', () => {
                    openDeleteModal('topic', topicId, 'Are you sure you want to delete this topic? This will also delete all subtopics within it.');
                });
            }

            // Create document editor
            createDocumentEditor(topic);
        }

        // Load subtopic content
        function loadSubtopic(topicId, subtopicId) {
            const subtopic = currentLesson.topics[topicId].subtopics[subtopicId];
            currentSubtopic = {
                id: subtopicId,
                topicId: topicId,
                ...subtopic
            };

            updateBreadcrumb('subtopic', subtopic.title, topicId, currentLesson.topics[topicId].title);

            document.getElementById('contentTitle').textContent = subtopic.title;

            const contentActions = document.getElementById('contentActions');

            if (!currentLesson.shared || currentLesson.accessLevel === 'edit') {
                contentActions.innerHTML = `
                    <button class="content-action-btn" id="addNoteBtn">
                        <i class="fas fa-sticky-note"></i>
                    </button>
                    <button class="content-action-btn" id="addLinkBtn">
                        <i class="fas fa-link"></i>
                    </button>
                    <button class="content-action-btn" id="addImageBtn">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="content-action-btn delete-btn" id="deleteSubtopicBtn">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            } else {
                contentActions.innerHTML = '';
            }

            // Setup content action buttons
            if (document.getElementById('addNoteBtn')) {
                document.getElementById('addNoteBtn').addEventListener('click', () => {
                    showAddContentModal('note', topicId, subtopicId);
                });
            }

            if (document.getElementById('addLinkBtn')) {
                document.getElementById('addLinkBtn').addEventListener('click', () => {
                    showAddContentModal('link', topicId, subtopicId);
                });
            }

            if (document.getElementById('addImageBtn')) {
                document.getElementById('addImageBtn').addEventListener('click', () => {
                    showAddContentModal('image', topicId, subtopicId);
                });
            }

            if (document.getElementById('deleteSubtopicBtn')) {
                document.getElementById('deleteSubtopicBtn').addEventListener('click', () => {
                    openDeleteModal('subtopic', subtopicId, 'Are you sure you want to delete this subtopic?');
                });
            }

            // Create document editor
            createDocumentEditor(subtopic);
        }

        // Create document editor
        function createDocumentEditor(item) {
            const contentBody = document.getElementById('contentBody');

            // Get existing content
            const existingContent = item.content ? item.content.text || '' : '';

            contentBody.innerHTML = `
                <div class="document-editor">
                    <div class="editor-toolbar">
                        <button class="editor-btn" id="boldBtn" title="Bold">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button class="editor-btn" id="italicBtn" title="Italic">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button class="editor-btn" id="underlineBtn" title="Underline">
                            <i class="fas fa-underline"></i>
                        </button>
                        <button class="editor-btn" id="headingBtn" title="Heading">
                            <i class="fas fa-heading"></i>
                        </button>
                        <button class="editor-btn" id="listBtn" title="List">
                            <i class="fas fa-list"></i>
                        </button>
                        <button class="editor-btn" id="tableBtn" title="Table">
                            <i class="fas fa-table"></i>
                        </button>
                        <button class="editor-btn" id="chartBtn" title="Chart">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                        <button class="editor-btn" id="checkboxBtn" title="Checkbox">
                            <i class="fas fa-check-square"></i>
                        </button>
                        <button class="editor-btn" id="linkBtn" title="Link">
                            <i class="fas fa-link"></i>
                        </button>
                        <button class="editor-btn" id="imageBtn" title="Image">
                            <i class="fas fa-image"></i>
                        </button>
                    </div>
                    <div class="editor-content" contenteditable="true" id="editorContent">
                        ${existingContent}
                    </div>
                </div>
            `;

            // Setup editor toolbar buttons
            setupEditorToolbar(item);
        }

        // Setup editor toolbar
        function setupEditorToolbar(item) {
            const editorContent = document.getElementById('editorContent');

            // Bold button
            document.getElementById('boldBtn').addEventListener('click', () => {
                document.execCommand('bold', false, null);
                editorContent.focus();
            });

            // Italic button
            document.getElementById('italicBtn').addEventListener('click', () => {
                document.execCommand('italic', false, null);
                editorContent.focus();
            });

            // Underline button
            document.getElementById('underlineBtn').addEventListener('click', () => {
                document.execCommand('underline', false, null);
                editorContent.focus();
            });

            // Heading button
            document.getElementById('headingBtn').addEventListener('click', () => {
                document.execCommand('formatBlock', false, '<h3>');
                editorContent.focus();
            });

            // List button
            document.getElementById('listBtn').addEventListener('click', () => {
                document.execCommand('insertUnorderedList', false, null);
                editorContent.focus();
            });

            // Table button
            document.getElementById('tableBtn').addEventListener('click', () => {
                const tableHtml = `
                    <div class="table-container">
                        <table class="custom-table">
                            <tr>
                                <th>Header 1</th>
                                <th>Header 2</th>
                                <th>Header 3</th>
                            </tr>
                            <tr>
                                <td>Cell 1</td>
                                <td>Cell 2</td>
                                <td>Cell 3</td>
                            </tr>
                            <tr>
                                <td>Cell 4</td>
                                <td>Cell 5</td>
                                <td>Cell 6</td>
                            </tr>
                        </table>
                    </div>
                `;
                document.execCommand('insertHTML', false, tableHtml);
                editorContent.focus();
            });

            // Chart button
            document.getElementById('chartBtn').addEventListener('click', () => {
                const chartHtml = `
                    <div class="chart-container">
                        <div class="chart-placeholder">
                            <i class="fas fa-chart-bar" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>Chart Placeholder</p>
                            <p style="font-size: 0.8rem;">In a real application, this would embed an interactive chart</p>
                        </div>
                    </div>
                `;
                document.execCommand('insertHTML', false, chartHtml);
                editorContent.focus();
            });

            // Checkbox button
            document.getElementById('checkboxBtn').addEventListener('click', () => {
                const checkboxHtml = `
                    <div class="checkbox-container">
                        <div class="checkbox-item">
                            <input type="checkbox" id="checkbox1">
                            <label for="checkbox1">Option 1</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="checkbox2">
                            <label for="checkbox2">Option 2</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="checkbox3">
                            <label for="checkbox3">Option 3</label>
                        </div>
                    </div>
                `;
                document.execCommand('insertHTML', false, checkboxHtml);
                editorContent.focus();
            });

            // Link button
            document.getElementById('linkBtn').addEventListener('click', () => {
                const url = prompt('Enter URL:');
                if (url) {
                    document.execCommand('createLink', false, url);
                }
                editorContent.focus();
            });

            // Image button
            document.getElementById('imageBtn').addEventListener('click', () => {
                const url = prompt('Enter image URL:');
                if (url) {
                    document.execCommand('insertImage', false, url);
                }
                editorContent.focus();
            });

            // Save content on blur
            editorContent.addEventListener('blur', () => {
                saveContent(item, editorContent.innerHTML);
            });
        }

        // Save content to Firebase
        function saveContent(item, content) {
            // Check if user has edit permission
            if (currentLesson.shared && currentLesson.accessLevel === 'read') {
                return;
            }

            let refPath;

            if (currentSubtopic) {
                refPath = `lessons/${currentLesson.id}/topics/${currentSubtopic.topicId}/subtopics/${currentSubtopic.id}`;
            } else if (currentTopic) {
                refPath = `lessons/${currentLesson.id}/topics/${currentTopic.id}`;
            } else {
                return;
            }

            // Get existing content
            database.ref(refPath).once('value')
                .then(snapshot => {
                    const existingData = snapshot.val() || {};
                    const existingContent = existingData.content || {};

                    // Update text content
                    existingContent.text = content;

                    // Save to Firebase
                    database.ref(refPath).update({
                        content: existingContent
                    })
                        .then(() => {
                            console.log('Content saved successfully');
                        })
                        .catch(error => {
                            console.error("Error saving content:", error);
                        });
                });
        }

        // Add a new topic
        function addTopic() {
            const topicName = document.getElementById('topicNameInput').value.trim();

            if (!topicName) {
                showNotification('Please enter a topic name', 'error');
                return;
            }

            // Assign a random gradient
            const gradientClass = gradientOptions[Math.floor(Math.random() * gradientOptions.length)];

            // Create topic in Firebase
            const topicId = database.ref(`lessons/${currentLesson.id}/topics`).push().key;

            database.ref(`lessons/${currentLesson.id}/topics/${topicId}`).set({
                title: topicName,
                createdBy: currentUser.id,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                gradientClass: gradientClass,
                content: {
                    text: '',
                    links: [],
                    images: []
                },
                subtopics: {}
            })
                .then(() => {
                    // Clear form and close modal
                    document.getElementById('topicNameInput').value = '';
                    document.getElementById('addTopicModal').classList.remove('active');

                    // Reload lesson
                    database.ref(`lessons/${currentLesson.id}`).once('value')
                        .then(snapshot => {
                            currentLesson = {
                                id: currentLesson.id,
                                ...snapshot.val()
                            };

                            // Reload navigation tree
                            loadNavigationTree();

                            // Reload lesson overview
                            loadLessonOverview();

                            // Show success message
                            showNotification('Topic added successfully!');
                        });
                })
                .catch(error => {
                    console.error("Error adding topic:", error);
                    showNotification('Error adding topic. Please try again.', 'error');
                });
        }

        // Show add content modal
        function showAddContentModal(type, topicId, subtopicId) {
            const modal = document.getElementById('addContentModal');
            const title = document.getElementById('addContentTitle');
            const body = document.getElementById('addContentBody');

            modal.dataset.contentType = type;
            modal.dataset.topicId = topicId;
            modal.dataset.subtopicId = subtopicId || '';

            switch (type) {
                case 'subtopic':
                    title.textContent = 'Add Subtopic';
                    body.innerHTML = `
                        <div class="form-group">
                            <label for="subtopicNameInput">Subtopic Name</label>
                            <input type="text" id="subtopicNameInput" placeholder="Enter subtopic name">
                        </div>
                    `;
                    break;

                case 'note':
                    title.textContent = 'Add Note';
                    body.innerHTML = `
                        <div class="form-group">
                            <label for="noteContentInput">Note Content</label>
                            <textarea id="noteContentInput" placeholder="Enter your note"></textarea>
                        </div>
                    `;
                    break;

                case 'link':
                    title.textContent = 'Add Link';
                    body.innerHTML = `
                        <div class="form-group">
                            <label for="linkTitleInput">Link Title</label>
                            <input type="text" id="linkTitleInput" placeholder="Enter link title">
                        </div>
                        <div class="form-group">
                            <label for="linkUrlInput">Link URL</label>
                            <input type="url" id="linkUrlInput" placeholder="Enter link URL">
                        </div>
                    `;
                    break;

                case 'image':
                    title.textContent = 'Add Image';
                    body.innerHTML = `
                        <div class="form-group">
                            <label for="imageUrlInput">Image URL</label>
                            <input type="url" id="imageUrlInput" placeholder="Enter image URL">
                        </div>
                        <div class="form-group">
                            <label for="imageAltInput">Image Alt Text</label>
                            <input type="text" id="imageAltInput" placeholder="Enter image description">
                        </div>
                    `;
                    break;
            }

            modal.classList.add('active');
        }

        // Add content to topic or subtopic
        function addContent() {
            const modal = document.getElementById('addContentModal');
            const type = modal.dataset.contentType;
            const topicId = modal.dataset.topicId;
            const subtopicId = modal.dataset.subtopicId;

            let updateData = {};
            let refPath;

            if (subtopicId) {
                refPath = `lessons/${currentLesson.id}/topics/${topicId}/subtopics/${subtopicId}`;
            } else {
                refPath = `lessons/${currentLesson.id}/topics/${topicId}`;
            }

            // Get current content
            database.ref(refPath).once('value')
                .then(snapshot => {
                    const item = snapshot.val();
                    const content = item.content || {};

                    switch (type) {
                        case 'subtopic':
                            const subtopicName = document.getElementById('subtopicNameInput').value.trim();
                            if (!subtopicName) {
                                showNotification('Please enter a subtopic name', 'error');
                                return;
                            }

                            // Assign a random gradient
                            const gradientClass = gradientOptions[Math.floor(Math.random() * gradientOptions.length)];

                            // Create subtopic in Firebase
                            const newSubtopicId = database.ref(`${refPath}/subtopics`).push().key;

                            return database.ref(`${refPath}/subtopics/${newSubtopicId}`).set({
                                title: subtopicName,
                                createdBy: currentUser.id,
                                createdAt: firebase.database.ServerValue.TIMESTAMP,
                                gradientClass: gradientClass,
                                content: {
                                    text: '',
                                    links: [],
                                    images: []
                                }
                            });

                        case 'note':
                            const noteText = document.getElementById('noteContentInput').value.trim();
                            if (!noteText) {
                                showNotification('Please enter note content', 'error');
                                return;
                            }

                            content.text = (content.text || '') + '\n\n' + noteText;
                            updateData.content = content;
                            break;

                        case 'link':
                            const linkTitle = document.getElementById('linkTitleInput').value.trim();
                            const linkUrl = document.getElementById('linkUrlInput').value.trim();

                            if (!linkUrl) {
                                showNotification('Please enter link URL', 'error');
                                return;
                            }

                            if (!content.links) content.links = [];
                            content.links.push({
                                title: linkTitle || linkUrl,
                                url: linkUrl
                            });
                            updateData.content = content;
                            break;

                        case 'image':
                            const imageUrl = document.getElementById('imageUrlInput').value.trim();
                            const imageAlt = document.getElementById('imageAltInput').value.trim();

                            if (!imageUrl) {
                                showNotification('Please enter image URL', 'error');
                                return;
                            }

                            if (!content.images) content.images = [];
                            content.images.push({
                                url: imageUrl,
                                alt: imageAlt || 'Image'
                            });
                            updateData.content = content;
                            break;
                    }

                    // Update item with new content
                    return database.ref(refPath).update(updateData);
                })
                .then(() => {
                    // Close modal and reload content
                    modal.classList.remove('active');

                    // Reload lesson
                    database.ref(`lessons/${currentLesson.id}`).once('value')
                        .then(snapshot => {
                            currentLesson = {
                                id: currentLesson.id,
                                ...snapshot.val()
                            };

                            // Reload navigation tree
                            loadNavigationTree();

                            // Reload current content
                            if (subtopicId) {
                                loadSubtopic(topicId, subtopicId);
                            } else if (type !== 'subtopic') {
                                loadTopic(topicId);
                            } else {
                                loadLessonOverview();
                            }

                            // Show success message
                            showNotification('Content added successfully!');
                        });
                })
                .catch(error => {
                    console.error("Error adding content:", error);
                    showNotification('Error adding content. Please try again.', 'error');
                });
        }

        // Export lesson as PDF
        function exportLesson() {
            showNotification('Preparing PDF export...', 'info');

            // Create a new jsPDF instance
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Set up the document
            doc.setFontSize(12);
            doc.setTextColor(40, 40, 40);

            // Add title
            doc.setFontSize(20);
            doc.setTextColor(74, 108, 247);
            doc.text(currentLesson.title, 105, 20);

            // Add description
            doc.setFontSize(12);
            doc.setTextColor(80, 80, 80);
            const description = currentLesson.description || 'No description available';
            const splitDescription = doc.splitTextToSize(description, 190, 12);
            doc.text(splitDescription, 105, 35);

            // Add topics and subtopics
            let yPosition = 60;

            if (currentLesson.topics) {
                Object.keys(currentLesson.topics).forEach(topicId => {
                    const topic = currentLesson.topics[topicId];

                    // Topic title
                    doc.setFontSize(16);
                    doc.setTextColor(60, 60, 60);
                    doc.text(`Topic: ${topic.title}`, 105, yPosition);
                    yPosition += 10;

                    // Topic content
                    if (topic.content && topic.content.text) {
                        doc.setFontSize(11);
                        doc.setTextColor(80, 80, 80);
                        const splitContent = doc.splitTextToSize(topic.content.text, 190, 11);
                        doc.text(splitContent, 105, yPosition);
                        yPosition += 7 * splitContent.length;
                    }

                    // Subtopics
                    if (topic.subtopics) {
                        Object.keys(topic.subtopics).forEach(subtopicId => {
                            const subtopic = topic.subtopics[subtopicId];

                            // Subtopic title
                            doc.setFontSize(14);
                            doc.setTextColor(70, 70, 70);
                            doc.text(`  ${subtopic.title}`, 105, yPosition);
                            yPosition += 8;

                            // Subtopic content
                            if (subtopic.content && subtopic.content.text) {
                                doc.setFontSize(10);
                                doc.setTextColor(90, 90, 90);
                                const splitContent = doc.splitTextToSize(subtopic.content.text, 185, 10);
                                doc.text(splitContent, 105, yPosition);
                                yPosition += 6 * splitContent.length;
                            }
                        });
                    }

                    yPosition += 10;
                });
            }

            // Save the PDF
            doc.save(`${currentLesson.title}.pdf`);

            showNotification('PDF exported successfully!');
        }

        // Open share modal
        function openShareModal() {
            document.getElementById('shareModal').classList.add('active');

            // Reset share options
            document.querySelectorAll('.share-option').forEach(option => {
                option.classList.remove('active');
                option.querySelector('.share-details').style.display = 'none';
            });

            // Reset access level options
            document.querySelectorAll('.access-option').forEach(option => {
                option.classList.remove('active');
            });

            // Set default access level
            document.querySelector('.access-option[data-access="read"]').classList.add('active');
        }

        // Load benches for sharing
        function loadBenchesForShare() {
            const benchSelect = document.getElementById('shareBenchSelect');
            benchSelect.innerHTML = '<option value="">Select a bench</option>';

            database.ref('benches').orderByChild('members/' + currentUser.id).equalTo(true).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const bench = childSnapshot.val();
                            const benchId = childSnapshot.key;

                            const option = document.createElement('option');
                            option.value = benchId;
                            option.textContent = bench.name;
                            benchSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error("Error loading benches:", error);
                });
        }

        // Generate share link
        function generateShareLink() {
            const shareLinkInput = document.getElementById('shareLinkInput');
            const shareCode = generateShareCode();
            const shareLink = `mindset.app/learn/${currentLesson.id}?code=${shareCode}`;

            shareLinkInput.value = shareLink;

            // Save share code to Firebase
            database.ref(`lessons/${currentLesson.id}/shareCode`).set(shareCode)
                .catch(error => {
                    console.error("Error saving share code:", error);
                });
        }

        // Generate unique 8-character alphanumeric code
        function generateShareCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Share lesson
        function shareLesson() {
            const activeShareOption = document.querySelector('.share-option.active');
            const activeAccessOption = document.querySelector('.access-option.active');

            if (!activeShareOption || !activeAccessOption) {
                showNotification('Please select a share option and access level', 'error');
                return;
            }

            const shareType = activeShareOption.dataset.shareType;
            const accessLevel = activeAccessOption.dataset.access;

            switch (shareType) {
                case 'profile':
                    shareToProfile(accessLevel);
                    break;
                case 'bench':
                    shareToBench(accessLevel);
                    break;
                case 'link':
                    shareByLink(accessLevel);
                    break;
            }
        }

        // Share to profile
        function shareToProfile(accessLevel) {
            const username = document.getElementById('shareUsernameInput').value.trim();

            if (!username) {
                showNotification('Please enter a username', 'error');
                return;
            }

            // Find user by username
            database.ref('users').orderByChild('username').equalTo(username).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        let userId;
                        snapshot.forEach(childSnapshot => {
                            userId = childSnapshot.key;
                        });

                        // Add lesson to user's shared lessons
                        const shareData = {
                            lessonId: currentLesson.id,
                            sharedBy: currentUser.id,
                            accessLevel: accessLevel,
                            sharedAt: firebase.database.ServerValue.TIMESTAMP
                        };

                        database.ref(`users/${userId}/sharedLessons/${currentLesson.id}`).set(shareData)
                            .then(() => {
                                document.getElementById('shareModal').classList.remove('active');
                                showNotification('Lesson shared successfully!');
                            })
                            .catch(error => {
                                console.error("Error sharing lesson:", error);
                                showNotification('Error sharing lesson. Please try again.', 'error');
                            });
                    } else {
                        showNotification('User not found. Please check the username.', 'error');
                    }
                })
                .catch(error => {
                    console.error("Error finding user:", error);
                    showNotification('Error finding user. Please try again.', 'error');
                });
        }

        // Share to bench
        function shareToBench(accessLevel) {
            const benchId = document.getElementById('shareBenchSelect').value;

            if (!benchId) {
                showNotification('Please select a bench', 'error');
                return;
            }

            // Add lesson to bench's shared lessons
            const shareData = {
                lessonId: currentLesson.id,
                sharedBy: currentUser.id,
                accessLevel: accessLevel,
                sharedAt: firebase.database.ServerValue.TIMESTAMP
            };

            database.ref(`benches/${benchId}/sharedLessons/${currentLesson.id}`).set(shareData)
                .then(() => {
                    document.getElementById('shareModal').classList.remove('active');
                    showNotification('Lesson shared to bench successfully!');
                })
                .catch(error => {
                    console.error("Error sharing lesson to bench:", error);
                    showNotification('Error sharing lesson to bench. Please try again.', 'error');
                });
        }

        // Share by link
        function shareByLink(accessLevel) {
            const shareLink = document.getElementById('shareLinkInput').value;

            if (!shareLink) {
                showNotification('Please generate a share link', 'error');
                return;
            }

            // Save access level to Firebase
            database.ref(`lessons/${currentLesson.id}/shareAccess`).set(accessLevel)
                .then(() => {
                    // Copy link to clipboard
                    navigator.clipboard.writeText(shareLink)
                        .then(() => {
                            document.getElementById('shareModal').classList.remove('active');
                            showNotification('Share link copied to clipboard!');
                        })
                        .catch(err => {
                            console.error('Could not copy text: ', err);
                            showNotification('Error copying link. Please try again.', 'error');
                        });
                })
                .catch(error => {
                    console.error("Error setting share access:", error);
                    showNotification('Error setting share access. Please try again.', 'error');
                });
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notificationContainer = document.getElementById('notificationContainer');

            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error' : type === 'info' ? 'info' : type === 'warning' ? 'warning' : ''}`;
            notification.textContent = message;

            notificationContainer.appendChild(notification);

            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    notificationContainer.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Initialize the page
        window.onload = checkAuthState;
    </script>
</body>

</html>